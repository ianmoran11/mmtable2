---
title: "Tidy and untidy tables"
output: 
  rmarkdown::html_vignette:
    pandoc_args: ["--smart"]
vignette: >
  %\VignetteIndexEntry{Tidy and untidy tables}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r message=FALSE, warning=FALSE, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r message=FALSE, warning=FALSE, include=FALSE}
library(tidyverse)
library(mmtable2)
library(colorspace)
library("RColorBrewer")
library(scales)
library(gt)
library(htmltools)
pcolors <- RColorBrewer::brewer.pal(8,"Pastel2")
gm_df <- gapminder_mm %>% filter(var != "Life expectancy") %>% filter(continent != "Americas")
style_list = list(cell_text(align = "left"))
```

## Components of tidy and untidy tables

Let's start with the untidy table below:

```{r message=FALSE, warning=FALSE, echo=FALSE}
student_df %>%
  mmtable(table_data = value) +
  header_top(student) +
  header_top_left(grade) +
  header_left(class) +
  header_left_top(subject)
```

and the tidy table used to create it: 

```{r message=FALSE, warning=FALSE, echo=FALSE}
student_df %>% 
  select(everything(),value) %>% 
  gather(header,header_val) %>% 
  group_by(header) %>% 
  mutate(row_no = row_number()) %>% 
  filter(row_no < 6) %>% # print(n = 110)
  mutate(header_val = ifelse(row_number() == 5,"etc...",header_val)) %>% 
  mmtable(table_data = header_val) + header_top(header) +
  header_format(header,gt::cell_text(align = "center")) +
  cells_format(T,gt::cell_text(align = "center"))
```

The mmtable2 package provides a framework for mapping tidy tables to untidy tables --- mapping the second table to the first.  


To understand this mapping, lets take a more generalized representation of an untidy table.


```{r include=FALSE}
df <- 
crossing(
  HTL =c("HEADER TOP LEFT 1","HEADER TOP LEFT 2"),
  HL = c("HEADER LEFT"), 
  HT = c("HEADER TOP ",c("HEADER TOP  ")),
  HLT =c("HEADER LEFT TOP 1","HEADER LEFT TOP 2")
  ) %>% 
  bind_rows(.,.) %>%  mutate(CELLS = "CELL") 
```

```{r echo=FALSE, message=FALSE, echo=FALSE}
df %>% 
  mmtable(table_data = CELLS) + 
  header_top(HT) +
  header_top_left(HTL) +
  header_left(HL) +
  header_left_top(HLT) +
  header_format(HT,gt::cell_text(align = "center")) +
  cells_format(T,gt::cell_text(align = "center")) +
  header_format(HT,gt::cell_fill(color =pcolors[1])) +
  table_format(locations = cells_body(columns =3:6, rows = 1) ,gt::cell_fill(color =pcolors[2])) + #HTL
  header_format(HL,gt::cell_fill(color =pcolors[3])) +
  table_format(locations = cells_body(columns =1, rows = 3:6) ,gt::cell_fill(color =pcolors[4])) + #HLT
  cells_format(T,gt::cell_fill(color =pcolors[5])) + #Cells
  table_format(locations = cells_body(columns =1:2, rows = 1:2) ,gt::cell_fill(color =pcolors[7])) # Stub
```

The coloring of the table above outlines the main components of an untidy table. 

- **cells** make up the body of the table; and
- **headers** indicate what the cells' values represent.

Headers can further be classified according to their spatial relationship with the cells. 

- **top headers** are directly above their cells
- **left headers** are directly to the left of their cells
- **top left headers** are above the body of the table and either above or above-and-to-the-left of their cells
- **left top headers** are to the left of the body either left or left-and-above their cells

## mmtable2's syntax

Now let's take a look at mmtable2's syntax for mapping tidy to untidy tables.  

A table like this:

```{r message=FALSE, warning=FALSE, echo=FALSE}
mmt <- 
df %>% select(CELLS, HT,HTL,HL,HLT) %>% 
  gather(head,value) %>% group_by(head) %>%  mutate(row_no = row_number()) %>%
  filter(row_no < 6) %>% 
  mutate(value = ifelse(row_no == 5,"...", value)) %>% 
  mmtable(table_data = value) + header_top(head) +
  header_format(head,gt::cell_text(align = "center")) +
  cells_format(T,gt::cell_text(align = "center")) +
  table_format(locations = cells_body(columns =1) ,gt::cell_fill(color =pcolors[5])) +
  table_format(locations = cells_body(columns =2) ,gt::cell_fill(color =pcolors[1])) +
  table_format(locations = cells_body(columns =3) ,gt::cell_fill(color =pcolors[2])) +
  table_format(locations = cells_body(columns =4) ,gt::cell_fill(color =pcolors[3])) +
  table_format(locations = cells_body(columns =5) ,gt::cell_fill(color =pcolors[4]))
  
mmt %>%  cols_width( everything() ~px(130))
```

is mapped to an untidy with the following lines of code:

```{r message=FALSE, warning=FALSE, echo=FALSE, fig.align="center"}
knitr::include_graphics("https://mmtable2.s3-ap-southeast-2.amazonaws.com/table_code.png")
```

These commands identify the untidy table's:

- cells - `mmtable(table_data = CELLS)`
- top header - `header_top_left(HT)`
- top left header - `header_top_left(HTL)` 
- left header - `header_left(HL)` 
- left top header - `header_left_top(HLT)` 
 
## Other untidy table layouts

Many untidy tables stray from the layout above.

mmtable2 supports a wide array of header layouts. 

For example, here's a version of the table above using only left* headers.

```{r message=FALSE, warning=FALSE}
student_df %>%
  mmtable(value) +
  header_left(class) +
  header_left_top(subject) + 
  header_left_top(student) + 
  header_left_top(grade) 
```
