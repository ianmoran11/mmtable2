---
title: "Tidy and untidy tables"
output: 
  rmarkdown::html_vignette:
    pandoc_args: ["--smart"]
vignette: >
  %\VignetteIndexEntry{Table components}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r message=FALSE, warning=FALSE, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r message=FALSE, warning=FALSE, include=FALSE}
library(tidyverse)
library(mmtable2)
library(colorspace)
library("RColorBrewer")
library(scales)
library(gt)
library(htmltools)
pcolors <- RColorBrewer::brewer.pal(8,"Pastel2")
gm_df <- gapminder_mm %>% filter(var != "Life expectancy") %>% filter(continent != "Americas")
style_list = list(cell_text(align = "left"))
```

## Components of tidy and untidy tables

Let's start with the table below:

```{r message=FALSE, warning=FALSE, echo=FALSE}
student_df %>%
  mmtable(table_data = value) +
  header_top(student) +
  header_top_left(grade) +
  header_left(class) +
  header_left_top(subject)
```

And the tidy data frame used to create that table: 

```{r message=FALSE, warning=FALSE, echo=FALSE}
student_df %>% 
  select(everything(),value) %>% 
  gather(header,header_val) %>% 
  group_by(header) %>% 
  mutate(row_no = row_number()) %>% 
  filter(row_no < 6) %>% # print(n = 110)
  mutate(header_val = ifelse(row_number() == 5,"etc...",header_val)) %>% 
  mmtable(table_data = header_val) + header_top(header) +
  header_format(header,gt::cell_text(align = "center")) +
  cells_format(T,gt::cell_text(align = "center"))
```

mmtable2 provides a framework for mapping tidy tables to untidy tables --- mapping the second table to the first.  


To understand this mapping, lets take a more generalized representation of an untidy table.


```{r include=FALSE}
df <- 
crossing(
  HTL =c("HEADER TOP LEFT 1","HEADER TOP LEFT 2"),
  HL = c("HEADER LEFT"), 
  HT = c("HEADER TOP ",c("HEADER TOP  ")),
  HLT =c("HEADER LEFT TOP 1","HEADER LEFT TOP 2")
  ) %>% 
  bind_rows(.,.) %>%  mutate(CELLS = "CELL") 
```

```{r echo=FALSE, message=FALSE, echo=FALSE}
df %>% 
  mmtable(table_data = CELLS) + 
  header_top(HT) +
  header_top_left(HTL) +
  header_left(HL) +
  header_left_top(HLT) +
  header_format(HT,gt::cell_text(align = "center")) +
  cells_format(T,gt::cell_text(align = "center")) +
  header_format(HT,gt::cell_fill(color =pcolors[1])) +
  table_format(locations = cells_body(columns =3:6, rows = 1) ,gt::cell_fill(color =pcolors[2])) + #HTL
  header_format(HL,gt::cell_fill(color =pcolors[3])) +
  table_format(locations = cells_body(columns =1, rows = 3:6) ,gt::cell_fill(color =pcolors[4])) + #HLT
  cells_format(T,gt::cell_fill(color =pcolors[5])) + #Cells
  table_format(locations = cells_body(columns =1:2, rows = 1:2) ,gt::cell_fill(color =pcolors[7])) # Stub
```

The coloring of the table presents the main components of an untidy table. 

- **cells** make up the body of the table; and
- **headers** indicate what the cells' values represent.

Headers can further be classified according to their spatial relationship with the cells. 

- **top headers** are directly above their cells
- **left header** are directly to the left of their cells
- **top left** headers are above the body of the table and either above or above-and-to-the-left of their cells
- **left top** headers are to the left of the body either left or left-and-up with respect to their cells

## mmtable2's syntax

Now let't take a look at mmtable2's syntax for mapping tidy to untidy tables.  

It takes a tidy table like this: 

```{r message=FALSE, warning=FALSE, echo=FALSE}
mmt <- 
df %>% select(CELLS, HT,HTL,HL,HLT) %>% 
  gather(head,value) %>% group_by(head) %>%  mutate(row_no = row_number()) %>%
  filter(row_no < 6) %>% 
  mutate(value = ifelse(row_no == 5,"...", value)) %>% 
  mmtable(table_data = value) + header_top(head) +
  header_format(head,gt::cell_text(align = "center")) +
  cells_format(T,gt::cell_text(align = "center")) +
  table_format(locations = cells_body(columns =1) ,gt::cell_fill(color =pcolors[5])) +
  table_format(locations = cells_body(columns =2) ,gt::cell_fill(color =pcolors[1])) +
  table_format(locations = cells_body(columns =3) ,gt::cell_fill(color =pcolors[2])) +
  table_format(locations = cells_body(columns =4) ,gt::cell_fill(color =pcolors[3])) +
  table_format(locations = cells_body(columns =5) ,gt::cell_fill(color =pcolors[4]))
  
mmt %>%  cols_width( everything() ~px(130))
```

and maps it to the untidy table above with the following lines of code:

```{r message=FALSE, warning=FALSE, echo=FALSE}
code_txt_df <- 
tibble(txt = 
  c(
html("#>  df %>% "),
html("#>    mmtable(table_data = CELLS) +  "),  
html("#>      header_top(HT) +             "),  
html("#>      header_top_left(HTL) +       "),  
html("#>      header_left(HL) +            "),  
html("#>      header_left_top(HLT)         ")
))

tbl <- 
code_txt_df %>% 
  mmtable(table_data = txt) 

# tbl %>% tab_options(column_labels.hidden = T) %>%  gt::as_raw_html()
paste0('<table style="font-family: -apple-system, BlinkMacSystemFont, "Segoe UI"", Roboto, Oxygen, Ubuntu, Cantarell, "Helvetica Neue", "Fira Sans", "Droid Sans", Arial, sans-serif; display: table; border-collapse: collapse; margin-left: auto; margin-right: auto; color: #333333; font-size: 16px; font-weight: normal; font-style: normal; background-color: #FFFFFF; width: auto; border-top-style: solid; border-top-width: 2px; border-top-color: #A8A8A8; border-right-style: none; border-right-width: 2px; border-right-color: #D3D3D3; border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #A8A8A8; border-left-style: none; border-left-width: 2px; border-left-color: #D3D3D3;">
  
  
  <tbody style="border-top-style: solid; border-top-width: 2px; border-top-color: #D3D3D3; border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #D3D3D3;">
    <tr><td style="padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: solid; border-top-width: 1px; border-top-color: #D3D3D3; border-left-style: none; border-left-width: 1px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 1px; border-right-color: #D3D3D3; vertical-align: middle; overflow-x: hidden; text-align: left;  background-color: ',pcolors[8],'; color: #000000;">df %&gt;% </td></tr>
    <tr><td style="padding-top: 8px; padding-bottom: 8px; padding-left: 15px; padding-right: 5px; margin: 10px; border-top-style: solid; border-top-width: 1px; border-top-color: #D3D3D3; border-left-style: none; border-left-width: 1px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 1px; border-right-color: #D3D3D3; vertical-align: middle; overflow-x: hidden; text-align: left; background-color: ',pcolors[5],'; color: #000000;">  mmtable(CELLS) +  </td></tr>
    <tr><td style="padding-top: 8px; padding-bottom: 8px; padding-left: 40px; padding-right: 5px; margin: 10px; border-top-style: solid; border-top-width: 1px; border-top-color: #D3D3D3; border-left-style: none; border-left-width: 1px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 1px; border-right-color: #D3D3D3; vertical-align: middle; overflow-x: hidden; text-align: left; background-color: ',pcolors[1],'; color: #000000;">    header_top(HT) +             </td></tr>
    <tr><td style="padding-top: 8px; padding-bottom: 8px; padding-left: 40px; padding-right: 5px; margin: 10px; border-top-style: solid; border-top-width: 1px; border-top-color: #D3D3D3; border-left-style: none; border-left-width: 1px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 1px; border-right-color: #D3D3D3; vertical-align: middle; overflow-x: hidden; text-align: left; background-color: ',pcolors[2],'; color: #000000;">    header_top_left(HTL) +       </td></tr>
    <tr><td style="padding-top: 8px; padding-bottom: 8px; padding-left: 40px; padding-right: 5px; margin: 10px; border-top-style: solid; border-top-width: 1px; border-top-color: #D3D3D3; border-left-style: none; border-left-width: 1px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 1px; border-right-color: #D3D3D3; vertical-align: middle; overflow-x: hidden; text-align: left; background-color: ',pcolors[3],'; color: #000000;">    header_left(HL) +            </td></tr>
    <tr><td style="padding-top: 8px; padding-bottom: 8px; padding-left: 40px; padding-right: 5px; margin: 10px; border-top-style: solid; border-top-width: 1px; border-top-color: #D3D3D3; border-left-style: none; border-left-width: 1px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 1px; border-right-color: #D3D3D3; vertical-align: middle; overflow-x: hidden; text-align: left; background-color: ',pcolors[4],'; color: #000000;">    header_left_top(HLT)         </td></tr>
  </tbody>
  
  
</table>') %>% htmltools::HTML()
```

These commands identify the untidy table's:

- cells - `mmtable(table_data = CELLS)`
- top header - `mmtable(table_data = CELLS)`
- top left header - `header_top_left(HTL)` 
- left header - `header_left(HL)` 
- left top header - `header_left_top(HLT)` 
 
## Other untidy table layouts

Many untidy tables stray from the layout above (using each type of header once).

mmtable2 supports this. 

For example here's a version of the table above using only left* headers.

```{r message=FALSE, warning=FALSE}
student_df %>%
  mmtable(value) +
  header_left(class) +
  header_left_top(subject) + 
  header_left_top(student) + 
  header_left_top(grade) 
```
